services:
  # ============================================================================
  # Video Processing Server
  # ============================================================================
  video-server:
    image: zencourt-video-server:latest
    build:
      context: ../..
      dockerfile: apps/video-server/Dockerfile
    container_name: zencourt-video-server
    ports:
      - "3001:3001"
    env_file:
      - ../../.env.local
    environment:
      NODE_ENV: development
      PORT: 3001
      LOG_LEVEL: debug

      # Redis Configuration
      REDIS_HOST: redis
      REDIS_PORT: 6379

      # Vercel Webhook Configuration
      VERCEL_API_URL: http://host.docker.internal:3000
      WEBHOOK_RETRY_ATTEMPTS: 5
      WEBHOOK_RETRY_BACKOFF_MS: 1000

      # Processing Configuration
      MAX_CONCURRENT_JOBS: 1
      JOB_TIMEOUT_MS: 600000
      TEMP_DIR: /tmp/video-processing

      # fal.ai Configuration
      FAL_WEBHOOK_URL: http://host.docker.internal:3001/webhooks/fal
    # volumes:
    #   # Mount source code for hot reload in development
    #   - ./src:/app/src:ro
    #   - ./dist:/app/dist
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 120s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ============================================================================
  # Redis (Queue Backend)
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: zencourt-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

volumes:
  redis-data:
    driver: local
