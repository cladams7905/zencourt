version: '3.8'

services:
  # ============================================================================
  # Video Processing Server
  # ============================================================================
  video-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: zencourt-video-server
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: development
      PORT: 3001
      LOG_LEVEL: debug

      # AWS Configuration (using LocalStack)
      AWS_REGION: us-east-1
      AWS_S3_BUCKET: zencourt-media-dev
      AWS_ENDPOINT: http://localstack:4566
      AWS_FORCE_PATH_STYLE: 'true'
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test

      # Redis Configuration
      REDIS_HOST: redis
      REDIS_PORT: 6379

      # Vercel Webhook Configuration
      VERCEL_API_URL: http://host.docker.internal:3000
      WEBHOOK_RETRY_ATTEMPTS: 5
      WEBHOOK_RETRY_BACKOFF_MS: 1000

      # Processing Configuration
      MAX_CONCURRENT_JOBS: 1
      JOB_TIMEOUT_MS: 600000
      TEMP_DIR: /tmp/video-processing

      # API Authentication
      AWS_API_KEY: dev-test-api-key-12345
    volumes:
      # Mount source code for hot reload in development
      - ./src:/app/src:ro
      - ./dist:/app/dist
    depends_on:
      - redis
      - localstack
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ============================================================================
  # Redis (Queue Backend)
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: zencourt-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # ============================================================================
  # LocalStack (S3 Simulation)
  # ============================================================================
  localstack:
    image: localstack/localstack:latest
    container_name: zencourt-localstack
    ports:
      - "4566:4566"
      - "4571:4571"
    environment:
      SERVICES: s3
      DEBUG: 1
      DATA_DIR: /tmp/localstack/data
      DOCKER_HOST: unix:///var/run/docker.sock
    volumes:
      - localstack-data:/tmp/localstack
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped

volumes:
  redis-data:
    driver: local
  localstack-data:
    driver: local
